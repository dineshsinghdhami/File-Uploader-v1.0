<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>File Uploader v1.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container my-5">
  
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
      <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <div class="py-4 text-center bg-secondary text-white rounded">
    <h1 class="mb-4 upload-heading">Upload Your Files</h1>

    <form method="post" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      <div class="form-row justify-content-center">
        <div class="col-12 col-md-6 mb-2">

          <input type="file" name="file" class="form-control-file" id="id_file" required 
                 accept="*">
        </div>
        <div class="col-12 col-md-auto">
          <button type="submit" class="btn btn-danger btn-block px-4" id="uploadBtn">Upload</button>
        </div>
      </div>
    </form>
    
    <div class="storage-info">
      <div class="storage-header">
        <i class="fas fa-hard-drive"></i>
        <span>Storage Usage</span>
      </div>
      
      <div class="storage-meter">
        <div class="storage-details">
          <span>Used:</span>
          <span style="color: var(--terminal-cyan);" id="storageUsed">
            {{ storage_info.used_mb|floatformat:2 }} MB / {{ storage_info.max_mb }} MB
          </span>
        </div>
        
        <div class="storage-bar">
          <div class="storage-progress" id="storageProgress" 
               style="width: {% if storage_info.used_percentage > 100 %}100{% else %}{{ storage_info.used_percentage }}{% endif %}%;
                      background: {% if storage_info.used_percentage > 90 %}var(--terminal-magenta)
                                 {% elif storage_info.used_percentage > 75 %}var(--terminal-yellow)
                                 {% else %}var(--terminal-green)
                                 {% endif %};">
          </div>
        </div>
        
        <div class="storage-footer">
          <span>Remaining:</span>
          <span style="color: var(--terminal-cyan);" id="storageRemaining">
            {{ storage_info.remaining_mb|floatformat:2 }} MB
          </span>
        </div>
      </div>
      
      <div class="storage-warning">
        <i class="fas fa-info-circle"></i>
        Maximum file size: 5MB. Images are automatically compressed.
      </div>
    </div>
    

    <div class="file-stats">
      <div class="file-stats-header">
        <i class="fas fa-chart-bar"></i>
        <span>File Statistics</span>
      </div>
      
      <div class="stats-grid">
        <div class="stat-box">
          <i class="fas fa-file" style="color: var(--terminal-text);"></i>
          <div class="stat-count">{{ files|length }}</div>
          <div class="stat-label">Total Files</div>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-image" style="color: var(--terminal-cyan);"></i>
          <div class="stat-count">{{ image_count|default:0 }}</div>
          <div class="stat-label">Images</div>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-music" style="color: var(--terminal-magenta);"></i>
          <div class="stat-count">{{ audio_count|default:0 }}</div>
          <div class="stat-label">Audio</div>
        </div>
        
        <div class="stat-box">
          <i class="fas fa-video" style="color: var(--terminal-yellow);"></i>
          <div class="stat-count">{{ video_count|default:0 }}</div>
          <div class="stat-label">Videos</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    {% for x in files %}
      <div class="col-12 col-sm-6 col-md-4">
        <div class="card mb-3 shadow-sm">

         
          <div class="file-icon-container">

            <i class="fas {{ x.get_file_icon|default:'fa-file' }} file-icon" 
               data-type="{{ x.get_file_type|lower }}"></i>
            <div class="filename-preview" title="{{ x.filename }}">
              {{ x.filename|truncatechars:30 }}
            </div>
            <small class="text-muted">{{ x.extension|upper }} file ‚Ä¢ {{ x.get_size_display }}</small>
          </div>

          <div class="card-body text-center">
            <p class="mb-2"><strong>{{ x.filename }}</strong></p>
            
   
            <div class="file-type-badge" data-type="{{ x.extension }}">
              {{ x.extension|upper }}
            </div>
            

            {% if x.file_exists %}
              <a href="{{ x.file.url }}" class="btn btn-sm btn-primary mt-2" download>
                <i class="fas fa-download"></i> Download
              </a>
            {% else %}
              <button class="btn btn-sm btn-secondary mt-2" disabled title="File not found on server">
                <i class="fas fa-exclamation-triangle"></i> Unavailable
              </button>
            {% endif %}
            
            <br>
            <small class="text-muted">
              <i class="fas fa-clock"></i> {{ x.uploaded_at|date:"M d, Y H:i" }}
            </small>
            {% if x.compressed_size > 0 %}
              <br>
              <small class="text-muted" title="Compression ratio">
                <i class="fas fa-compress"></i> Compressed: {{ x.compression_ratio }}
              </small>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12 text-center text-muted mt-4">
        <i class="fas fa-folder-open fa-2x mb-3"></i>
        <p>No files uploaded yet.</p>
      </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_file');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const usedPercentage = {{ storage_info.used_percentage|default:0 }};
    const usedMB = {{ storage_info.used_mb|default:0 }};
    const remainingMB = {{ storage_info.remaining_mb|default:500 }};
    

    if (usedPercentage > 90) {
        showStorageWarning();
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 5 * 1024 * 1024;
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                

                if (file.size > maxSize) {
                    showError(`File too large!\n\nSelected: ${file.name}\nSize: ${sizeInMB} MB\nMax allowed: 5MB\n\nPlease select a smaller file.`);
                    e.target.value = '';
                    disableUploadButton();
                } 

                else if (file.size > remainingMB * 1024 * 1024) {
                    showError(`Insufficient storage!\n\nFile size: ${sizeInMB} MB\nAvailable: ${remainingMB.toFixed(2)} MB\n\nPlease delete some files or select a smaller file.`);
                    e.target.value = '';
                    disableUploadButton();
                }
                else {
                    console.log(`üìÅ Selected: ${file.name} (${sizeInMB} MB)`);
                    

                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const fileType = getFileType(fileExtension);
                    
                    if (fileType === 'image' && sizeInMB > 1) {
                        showInfo(`Image will be compressed from ${sizeInMB}MB to ~500KB`);
                    }
                    

                    if (uploadBtn) {
                        uploadBtn.innerHTML = `Upload ${fileType.charAt(0).toUpperCase() + fileType.slice(1)}`;
                    }
                    
                    enableUploadButton();
                }
            }
        });
    }
    

    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            const file = fileInput?.files[0];
            if (file) {

                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    uploadBtn.disabled = true;
                }
            }
        });
    }

    function showError(message) {
        alert('‚ùå ' + message);
    }
  
    function showInfo(message) {

        console.log('‚ÑπÔ∏è ' + message);
    }
    
    function getFileType(extension) {
        const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
        const audioTypes = ['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'];
        const videoTypes = ['mp4', 'avi', 'mov', 'wmv', 'mkv', 'webm'];
        const documentTypes = ['pdf', 'doc', 'docx', 'txt', 'ppt', 'pptx', 'xls'];
        const archiveTypes = ['zip', 'rar', '7z', 'tar', 'gz'];
        
        if (imageTypes.includes(extension)) return 'image';
        if (audioTypes.includes(extension)) return 'audio';
        if (videoTypes.includes(extension)) return 'video';
        if (documentTypes.includes(extension)) return 'document';
        if (archiveTypes.includes(extension)) return 'archive';
        return 'file';
    }
    
    function disableUploadButton() {
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.style.opacity = '0.5';
            uploadBtn.style.cursor = 'not-allowed';
            uploadBtn.innerHTML = 'Upload';
        }
    }
    
    function enableUploadButton() {
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = '1';
            uploadBtn.style.cursor = 'pointer';
        }
    }
    
    function showStorageWarning() {
        const warning = document.createElement('div');
        warning.className = 'storage-warning-popup';
        warning.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Storage Almost Full!</strong>
            </div>
            <div>${usedPercentage.toFixed(1)}% of storage used.</div>
            <div style="font-size: 0.8rem; margin-top: 5px;">
                Please delete some files to free up space.
            </div>
        `;
        document.body.appendChild(warning);
        

        setTimeout(() => {
            warning.style.opacity = '0';
            warning.style.transition = 'opacity 1s';
            setTimeout(() => warning.remove(), 1000);
        }, 10000);
    }
  
    if (fileInput && fileInput.files.length > 0) {
        enableUploadButton();
    }
});
</script>
</body>

</html>
